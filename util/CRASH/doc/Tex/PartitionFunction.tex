%  Copyright (C) 2002 Regents of the University of Michigan, portions used with permission 
%  For more information, see http://csem.engin.umich.edu/tools/swmf
\section{Appendix B: Partition function and excitation}
{\bf Common properties of mean values and covariances.}
Recall the definition of mean value (also referred to as "expected value"):
\begin{equation}
\langle f_i \rangle = \sum_i p_i f_i.
\end{equation}
Where $p_i$ acts as the probability of occurence of state $i$.
Covariance is constructed using the definition of mean value described above:
\begin{equation}
Cov(a,b) = \langle \delta a \delta b \rangle =
\langle (a - \langle a \rangle) (b - \langle b \rangle) \rangle,
\end{equation}
where $\delta a = a - \langle a \rangle$.
One of the useful properties of covariance is as follows:
\begin{equation}
\langle \delta a \delta b \rangle = \langle ab \rangle - \langle a \rangle \langle b \rangle,
\end{equation}
\begin{eqnarray}
\nonumber proof: \langle (a - \langle a \rangle) (b - \langle b \rangle) \rangle =
\langle ab - a \langle b \rangle - b \langle a \rangle + \langle a \rangle \langle b \rangle \rangle = \\ \nonumber
\langle ab \rangle - 2 \langle a \rangle \langle b \rangle + \langle a \rangle \langle b \rangle =
\langle ab \rangle - \langle a \rangle \langle b \rangle.
\end{eqnarray}
Another property we actually use in the code to optimize the
calculation of covariances is as follows:
\begin{equation}
\langle \delta a \delta b \rangle = \langle (a - \langle a \rangle) b \rangle,
\end{equation}
\begin{equation}
\nonumber proof: \langle \delta a \delta b \rangle =
\langle ab \rangle - \langle a \rangle \langle b \rangle =
\langle ab \rangle - \langle \langle a \rangle b \rangle =
\langle (a - \langle a \rangle) b \rangle.
\end{equation}
Even having no idea about particular properties of either $p_i$ and $f_i$,
one can derive the formula for $d \langle f_i \rangle$ as follows:
\begin{equation}\label{differmean}
d \langle f_i \rangle = \langle \delta f_i \delta \left( \frac{d p_i}{p_i} \right) \rangle +
\langle d f_i \rangle,
\end{equation}
which is useful to calculate partial derivatives of $\langle f_i \rangle$,
for example, $\frac{\partial \langle f_i \rangle}{\partial g_e}$.

Proof:
\begin{eqnarray}
\nonumber d \langle f_i \rangle &=&
d \left( \frac{\sum w_i f_i}{\sum w_i} \right) =
\frac{d(\sum w_i f_i)}{\sum w_i} - \frac{d(\sum w_i) \sum w_i f_i}{\sum w_i} = \\
\nonumber &=& \frac{\sum (w_i df_i + f_i dw_i)}{\sum w_i} - \frac{\sum dw_i}{\sum w_i} \langle f_i \rangle = \\
&=& \langle df_i \rangle + \langle f_i \frac{dw_i}{w_i} \rangle - \langle \frac{dw_i}{w_i} \rangle \langle f_i \rangle =
\langle \delta f_i \delta \left( \frac{dw_i}{w_i} \right) \rangle + \langle df_i \rangle,
\end{eqnarray}
where $w_i = p_i S$ are non-normalized partition functions.

To calculate covariances over several indices one can separate the indices using this formula:
\begin{equation}\label{sepcov}
\left\langle \delta f_{i,n} \delta g_{i,n} \right\rangle_{i,n} =
\left\langle \left\langle \delta f_{i,n} \delta g_{i,n} \right\rangle_n \right\rangle_i +
\left\langle \delta \left\langle f_{i,n} \right\rangle_n \delta \left\langle g_{i,n} \right\rangle_n \right\rangle_i.
\end{equation}

